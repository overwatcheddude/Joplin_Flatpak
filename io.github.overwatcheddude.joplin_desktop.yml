app-id: io.github.overwatcheddude.joplin_desktop
runtime: org.freedesktop.Platform//24.08
sdk: org.freedesktop.Sdk//24.08
command: joplin_desktop
finish-args:
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --share=network
  - --persist=

modules:
  - name: joplin_desktop
    buildsystem: simple
    build-commands:
      # Extract the .deb package
      - ar x Joplin-3.4.12.deb
      # Extract data file
      - tar xf data.tar.xz

      # --- Main Application Files ---
      # Create the main app directory and copy files from /opt
      - mkdir -p ${FLATPAK_DEST}/joplin_desktop
      - cp -r opt/Joplin/* ${FLATPAK_DEST}/joplin_desktop
      # Rename the actual executable 'joplin' to what our command expects
      - mv ${FLATPAK_DEST}/joplin_desktop/joplin ${FLATPAK_DEST}/joplin_desktop/joplin_desktop

      # --- Wrapper Script ---
      # Create the executable script in /app/bin
      - mkdir -p ${FLATPAK_DEST}/bin
      - |
        cat > ${FLATPAK_DEST}/bin/joplin_desktop << 'EOF'
        #!/bin/sh
        exec /app/joplin_desktop/joplin_desktop --no-sandbox "$@"
        EOF
      - chmod +x ${FLATPAK_DEST}/bin/joplin_desktop

      # --- Desktop Integration Files ---
      # Install icons to the standard location
      - mkdir -p ${FLATPAK_DEST}/share/icons/hicolor
      - cp -r usr/share/icons/hicolor ${FLATPAK_DEST}/share/icons/
      # Rename icons to match Flatpak app-id
      - find ${FLATPAK_DEST}/share/icons/hicolor -type f -name 'joplin.png' -exec bash -c 'for f; do mv "$f" "${f%/*}/io.github.overwatcheddude.joplin_desktop.png"; done' bash {} +

      # Install the .desktop file, renaming it to match the app-id
      - install -D usr/share/applications/joplin.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      # Update the Exec key in the .desktop file to be correct for Flatpak
      - sed -i 's/^Exec=.*/Exec=joplin_desktop/' ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      # Update the Icon key in the .desktop file to be correct for Flatpak
      - sed -i 's/^Icon=.*/Icon=io.github.overwatcheddude.joplin_desktop/' ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      
      # Remove 1024x1024 icon due to Freedesktop restriction
      - rm -f ${FLATPAK_DEST}/share/icons/hicolor/1024x1024/apps/io.github.overwatcheddude.joplin_desktop.png

    sources:
      - type: file
        url: https://github.com/laurent22/joplin/releases/download/v3.4.12/Joplin-3.4.12.deb
        sha256: 49fafcfe615ac90449f9ce4545f807f054221df49877dbe785dbc7157ed0860d
        dest-filename: Joplin-3.4.12.deb
